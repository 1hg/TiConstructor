#define USE_HEXDUMP
#define USE_WAIT8
#define USE_CPU_SPEED
#define USE_NUMBER
#include "../../lib/essentials.c"
#include "../../lib/textio.c"
#include "../../lib/misc.c"
#include "../../lib/userinput.c"
#include "../../lib/variables.c"





#define G_MAX_ROW 32/8
#define G_ROW_END  0x80 + 64
#define G_SCREEN_BUFFER _scoreboard_DATA
#define NO_USE_CLEAR
#define G_COL_START 0x20 + 12 - 4

#include "../../lib/graphics.c"

// #define NO_MICRO_WAIT 
#define ON_GREY_RENDER() __asm call _animate_board __endasm
#include "../../lib/greyscale.c"

// #define NO_USE_SWAP
// #define NO_USE_CLEAR



#define X_LINE 8
#define Y_MULT 		add	hl,hl \
				   	add	hl,hl \
				   	add	hl,hl
#define COPY_MODE or
#define GREYSCALE_SPRITES
#include "../../lib/spritemanager.c"





#define dataName addAppVarObj("gryCfg") // need to add type data to appVar name

#define gameName addAppVarObj("v2048s") // store 2048 board


#define gameData 0x84F3
#define animation_values 0x983C


#define some_vars ( animation_values + (4*4*2) +1 )
#define score_changed  *((char*)some_vars)
#include "calibration.c"


// Assets
	const char b2_DATA[] ={0b11111111, 0b10000000, 0b10000000, 0b10000000, 0b10000011, 0b10000100, 0b10000000, 0b10000001, 0b10000010, 0b10000100, 0b10000111, 0b10000000, 0b10000000, 0b10000000, 0b11111111, 0b11111110, 0b00000010, 0b00000010, 0b00000010, 0b10000010, 0b01000010, 0b10000010, 0b00000010, 0b00000010, 0b00000010, 0b11000010, 0b00000010, 0b00000010, 0b00000010, 0b11111110, 0b11111111, 0b10000000, 0b10000000, 0b10000000, 0b10000011, 0b10000100, 0b10000000, 0b10000001, 0b10000010, 0b10000100, 0b10000111, 0b10000000, 0b10000000, 0b10000000, 0b11111111, 0b11111110, 0b00000010, 0b00000010, 0b00000010, 0b10000010, 0b01000010, 0b10000010, 0b00000010, 0b00000010, 0b00000010, 0b11000010, 0b00000010, 0b00000010, 0b00000010, 0b11111110};
	#define b2_WIDTH 16/8
	#define b2_HEIGHT 15
	// greyPutSprite(x, y, b2_WIDTH, b2_HEIGHT, b2_DATA);
	const char b4_DATA[] ={0b11111111, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000001, 0b10000010, 0b10000100, 0b10000111, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b11111111, 0b11111110, 0b00000010, 0b00000010, 0b00000010, 0b10000010, 0b10000010, 0b10000010, 0b10000010, 0b11000010, 0b10000010, 0b10000010, 0b00000010, 0b00000010, 0b00000010, 0b11111110, 0b11111111, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000001, 0b10000010, 0b10000100, 0b10000111, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b11111111, 0b11111110, 0b00000010, 0b00000010, 0b00000010, 0b10000010, 0b10000010, 0b10000010, 0b10000010, 0b11000010, 0b10000010, 0b10000010, 0b00000010, 0b00000010, 0b00000010, 0b11111110};
	#define b4_WIDTH 16/8
	#define b4_HEIGHT 15
	// greyPutSprite(x, y, b4_WIDTH, b4_HEIGHT, b4_DATA);
	const char b8_DATA[] ={0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111111, 0b10000000, 0b10000000, 0b10000000, 0b10000011, 0b10000100, 0b10000100, 0b10000011, 0b10000100, 0b10000100, 0b10000011, 0b10000000, 0b10000000, 0b10000000, 0b11111111, 0b11111110, 0b00000010, 0b00000010, 0b00000010, 0b10000010, 0b01000010, 0b01000010, 0b10000010, 0b01000010, 0b01000010, 0b10000010, 0b00000010, 0b00000010, 0b00000010, 0b11111110};
	#define b8_WIDTH 16/8
	#define b8_HEIGHT 15
	// greyPutSprite(x, y, b8_WIDTH, b8_HEIGHT, b8_DATA);
	const char b16_DATA[] ={0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111111, 0b10000000, 0b10000000, 0b10000000, 0b10001000, 0b10011000, 0b10001001, 0b10001001, 0b10001001, 0b10001001, 0b10011100, 0b10000000, 0b10000000, 0b10000000, 0b11111111, 0b11111110, 0b00000010, 0b00000010, 0b00000010, 0b01100010, 0b10000010, 0b00000010, 0b11100010, 0b00010010, 0b00010010, 0b11100010, 0b00000010, 0b00000010, 0b00000010, 0b11111110};
	#define b16_WIDTH 16/8
	#define b16_HEIGHT 15
	// greyPutSprite(x, y, b16_WIDTH, b16_HEIGHT, b16_DATA);
	const char b32_DATA[] ={0b11111111, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b11111111, 0b11111110, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b11111110, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11000001, 0b11111011, 0b11110111, 0b11111011, 0b11111101, 0b11011101, 0b11100011, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b10001110, 0b01110110, 0b11101110, 0b11011110, 0b10111110, 0b01111110, 0b00000110, 0b11111110, 0b11111110, 0b11111110, 0b11111110};
	#define b32_WIDTH 16/8
	#define b32_HEIGHT 15
	// greyPutSprite(x, y, b32_WIDTH, b32_HEIGHT, b32_DATA);
	const char b64_DATA[] ={0b11111111, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b11111111, 0b11111110, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b11111110, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11110011, 0b11101111, 0b11011111, 0b11000011, 0b11011101, 0b11011101, 0b11100011, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11101110, 0b11001110, 0b10101110, 0b01101110, 0b00000110, 0b11101110, 0b11101110, 0b11111110, 0b11111110, 0b11111110, 0b11111110};
	#define b64_WIDTH 16/8
	#define b64_HEIGHT 15
	// greyPutSprite(x, y, b64_WIDTH, b64_HEIGHT, b64_DATA);
	const char b128_DATA[] ={0b11111111, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10010011, 0b10110000, 0b10010001, 0b10010010, 0b10111011, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b11111111, 0b11111110, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00111010, 0b10101010, 0b00111010, 0b00101010, 0b10111010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b11111110, 0b11111111, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10010011, 0b10110000, 0b10010001, 0b10010010, 0b10111011, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b11111111, 0b11111110, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00111010, 0b10101010, 0b00111010, 0b00101010, 0b10111010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b11111110};
	#define b128_WIDTH 16/8
	#define b128_HEIGHT 15
	// greyPutSprite(x, y, b128_WIDTH, b128_HEIGHT, b128_DATA);
	const char b256_DATA[] ={0b11111111, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10110011, 0b10001010, 0b10010011, 0b10100000, 0b10111011, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b11111111, 0b11111110, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b10011010, 0b00100010, 0b00111010, 0b10101010, 0b00111010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b11111110, 0b11111111, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10110011, 0b10001010, 0b10010011, 0b10100000, 0b10111011, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b11111111, 0b11111110, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b10011010, 0b00100010, 0b00111010, 0b10101010, 0b00111010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b11111110};
	#define b256_WIDTH 16/8
	#define b256_HEIGHT 15
	// greyPutSprite(x, y, b256_WIDTH, b256_HEIGHT, b256_DATA);
	const char b512_DATA[] ={0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111111, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10111001, 0b10100011, 0b10110001, 0b10001001, 0b10110011, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b11111111, 0b11111110, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00110010, 0b00001010, 0b00010010, 0b00100010, 0b10111010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b11111110};
	#define b512_WIDTH 16/8
	#define b512_HEIGHT 15
	// greyPutSprite(x, y, b512_WIDTH, b512_HEIGHT, b512_DATA);
	const char b1024_DATA[] ={0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111111, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10100100, 0b11101010, 0b10101010, 0b10101010, 0b11110100, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b11111111, 0b11111110, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b11010010, 0b00110110, 0b01011110, 0b10000110, 0b11100110, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b11111110};
	#define b1024_WIDTH 16/8
	#define b1024_HEIGHT 15
	// greyPutSprite(x, y, b1024_WIDTH, b1024_HEIGHT, b1024_DATA);
	const char b2048_DATA[] ={0b11111111, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b11111111, 0b11111110, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b11111110, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b10011010, 0b11100100, 0b11010100, 0b10110101, 0b10001011, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11100010, 0b10101010, 0b00100010, 0b10101010, 0b10100010, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110};
	#define b2048_WIDTH 16/8
	#define b2048_HEIGHT 15
	// greyPutSprite(x, y, b2048_WIDTH, b2048_HEIGHT, b2048_DATA);
	const char b4096_DATA[] ={0b11111111, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b11111111, 0b11111110, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b11111110, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b10111011, 0b10100101, 0b10000101, 0b11100101, 0b11101011, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b00010010, 0b01001110, 0b00000010, 0b11001010, 0b00100010, 0b11111110, 0b11111110, 0b11111110, 0b11111110, 0b11111110};
	#define b4096_WIDTH 16/8
	#define b4096_HEIGHT 15
	// greyPutSprite(x, y, b4096_WIDTH, b4096_HEIGHT, b4096_DATA);
	const char b8192_DATA[] ={0b11111111, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b11110100, 0b11011100, 0b11110100, 0b11010100, 0b11111110, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b11111111, 0b11111110, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b11111010, 0b10100110, 0b11101010, 0b00110010, 0b11011110, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b11111110, 0b11111111, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b11110100, 0b11011100, 0b11110100, 0b11010100, 0b11111110, 0b10000000, 0b10000000, 0b10000000, 0b10000000, 0b11111111, 0b11111110, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b11111010, 0b10100110, 0b11101010, 0b00110010, 0b11011110, 0b00000010, 0b00000010, 0b00000010, 0b00000010, 0b11111110};
	#define b8192_WIDTH 16/8
	#define b8192_HEIGHT 15
	// greyPutSprite(x, y, b8192_WIDTH, b8192_HEIGHT, b8192_DATA);



	const char scoreboard_DATA[] ={0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10011110, 0b00011100, 0b00001000, 0b01110001, 0b10010001, 0b00100010, 0b00011000, 0b10001001, 0b10000001, 0b00100010, 0b00011000, 0b10001001, 0b10000001, 0b00100010, 0b00101000, 0b10001001, 0b10000010, 0b00100010, 0b01001000, 0b01110001, 0b10000100, 0b00100010, 0b01001000, 0b10001001, 0b10001000, 0b00100010, 0b11111110, 0b10001001, 0b10010000, 0b00100010, 0b00001000, 0b10001001, 0b10011111, 0b00011100, 0b00001000, 0b11110001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10100010, 0b10000000, 0b00000000, 0b00000001, 0b10100010, 0b10000000, 0b00000000, 0b00000001, 0b10111001, 0b00000000, 0b00000000, 0b00000001, 0b10101001, 0b00000000, 0b00000000, 0b00000001, 0b10111001, 0b00000000, 0b00000000, 0b00000001, 0b10000000, 0b00000000, 0b00000000, 0b00000001, 0b10111001, 0b00001110, 0b10010100, 0b01110001, 0b10101000, 0b00010000, 0b10100100, 0b01000001, 0b10101001, 0b00100000, 0b11000100, 0b01000001, 0b10101001, 0b00100000, 0b11000100, 0b01110001, 0b10111001, 0b00100000, 0b10100100, 0b01000001, 0b10100001, 0b00010000, 0b10100100, 0b01000001, 0b10100001, 0b00001110, 0b10010111, 0b01110001, 0b11111111, 0b11111111, 0b11111111, 0b11111111};

	const char* NUM_DATA[] = {(char*)0, b2_DATA, b4_DATA, b8_DATA, b16_DATA, b32_DATA, b64_DATA, b128_DATA, b256_DATA, b512_DATA, b1024_DATA, b2048_DATA, b4096_DATA, b8192_DATA};


void animate_board()__naked{
	__asm

		in a, (4)
		bit 7, a
		ret z
	
		ld	a, #0x46
		out	(0x36), a	;128 Hz
		ld	a, #0
		out	(0x37), 	a
		ld	a, #5
		out	(0x38), a
	

		ld hl, #animation_values
		ld b, #4*4*2
		ld c, #0
		ld e, #1
		ANIM_LOOP:
			ld a, (hl)
			
			cp c
			jp z, END_OF_ANIM_LOOP
			ld e, #2
			jp p, SUB_ANIM
			add a, #3
			jp nc, AFTER_ZERO
			xor a, a
			jp AFTER_ZERO
			
			SUB_ANIM:
			sub a, #3
			jp nc, AFTER_ZERO
			xor a, a
			AFTER_ZERO:
			
			ld (hl), a

			END_OF_ANIM_LOOP:
			inc hl
			djnz ANIM_LOOP
		dec e
		ret z

		ld (some_vars+1), ix
		call _renderBoard
		ld ix, (some_vars+1)
		ret

	__endasm;
}

void renderBoard(){
	__asm
		ld hl, #animation_values
		push hl
		pop ix
		call _clearGreyScaleBuffer

		ld hl, #gameData

		ld d, #0
		X_BOARD_LOOP:
			ld e, #0
			Y_BOARD_LOOP:


				ld b, #0
				ld c, (hl)
				xor a, a
				cp c
				jp z, AFTER_DRAW

				push hl

				ld	hl, #__xinit__NUM_DATA // bc = NUM_DATA[gameData[i]]
				add hl, bc
				add hl, bc
				ld c, (hl)
				inc hl
				ld b, (hl)
				push	bc
				

				ld	hl, #0x0f02 // magic size number
				push	hl
				xor	a, a



				ld (0x8478), de

				ld a, (ix)
				add d
				ld d, a
				inc ix

				ld a, (ix)
				add e
				ld e, a
				inc ix
				
				push	de



				call	_greyPutSprite
				ld de, (0x8478)
				ld	hl, #6
				add	hl, sp
				ld	sp, hl

				pop hl

				AFTER_DRAW:

				inc hl

				ld a, e
				add a, #14
				ld e, a
				cp a, #14*4
				jp nz, Y_BOARD_LOOP


			ld a, d
			add a, #14
			ld d, a
			cp a, #14*4
			jp nz, X_BOARD_LOOP



	__endasm;

}

void set(){
	__asm

		ld a, #0
		ld hl, #animation_values
		ld (hl), a
		ld de, #animation_values+1
		ld bc, #32
		ldir
	__endasm;
	char* dataLoc=getOrCreateVar(dataName, 20)+2; 

	if (!(dataLoc[0] == 0x69 && dataLoc[3] == 0x69)){
		dataLoc[0] = 0x69;
		dataLoc[1] = 0x9F;
		dataLoc[2] = 0x15;
		dataLoc[3] = 0x69;
	}
	*(char*)(0x85A6) = dataLoc[1];
	*(char*)(0x85A6+1) = dataLoc[2];


	


	getOrCreateVar(gameName, 20); 
	__asm
		inc hl
		inc hl
		ld a, (hl)
		cp #0x69
		jp nz, NOT_RIGHT

			ld de, #gameData
			ld bc, #20
			ldir

			ld	sp, ix
			pop	ix
			ret
		NOT_RIGHT:
			xor a, a
			ld hl, #gameData
			ld (hl), a
			ld de, #gameData+1
			ld bc, #19
			ldir

	__endasm;

}

void random_spawn(){
	__asm

		ld a, r // r is the amount of cycles the calc has been running, great for a fast random(ish) num
		
		and a, #1
		inc a
		ld b, a  // b = 1 or 2 (amount of tiles to spawn)


		ld e, #18
		RAND_TILE_SPAWN_LOOP:

			push bc
			AFTER_PUSH_IN_RAND_TILE_SPAWN_LOOP:

			dec e
			jp z, END_OF_RAND


			ld b, #0

			ld a, r
			and a, #0x0F // 0 - 15
			ld c, a

			ld hl, #gameData
			add hl, bc
			ld a, (hl)
			
			inc a
			dec a
			jp nz, AFTER_PUSH_IN_RAND_TILE_SPAWN_LOOP

			ld a, r

			rrca // spin bits around to add variation
			rrca
			rrca
			ld b, #1

			and a, #0b00000111
			jp nz, ON_SET_STUFF
			
			inc b
			ON_SET_STUFF:
			ld (hl), b

			pop bc
			djnz RAND_TILE_SPAWN_LOOP
			push bc

			END_OF_RAND:
			pop bc

	__endasm;
}

void rotLeft()__naked{
	__asm
		push ix



		ld hl, # animation_values
		inc hl
		push hl
		pop ix

		ld hl, # gameData

		ld c, #4
		ROW_LOOP_LEFT:
			
			push ix
			push hl
			ld de, #COL_MOVE_LEFT_MLOOP
			push de

			ld d, #1

			ld b, #3
			COL_LOOP_LEFT:
				ld a, (hl)
				inc hl
				
				inc a
				dec a
				jp z, LEFT_COL_END_LOOP


				ld e, (hl)
				cp e
				jp nz, LEFT_COL_END_LOOP

				inc a
				dec hl
				ld (hl), a
				inc hl
				xor a, a
				ld (hl), a

				inc d

				LEFT_COL_END_LOOP:
				djnz COL_LOOP_LEFT
				ret
			


			COL_MOVE_LEFT_MLOOP:
				pop hl
				pop ix
				push ix
				push hl
				

				ld b, #3
				COL_MOVE_LEFT_LOOP:

					ld a, (hl)
					inc hl

					inc a
					dec a
					jp nz, COL_MOVE_LEFT_END_LOOP

					ld e, (hl)
					inc e
					dec e
					jp z, COL_MOVE_LEFT_END_LOOP

					xor a, a
					ld (hl), a
					dec hl
					ld (hl), e
					
					// ld a, 2(ix)
					ld a, #-15
					// add a, #15
					ld (ix), a

					jp COL_MOVE_LEFT_MLOOP


					COL_MOVE_LEFT_END_LOOP:
					inc ix
					inc ix
					djnz COL_MOVE_LEFT_LOOP

				pop hl
				pop ix
				push hl

				dec d
				jp nz, MRG


				ld de, #MRG
				ld b, #3

				push de
				jp COL_LOOP_LEFT


				MRG:
				pop hl
				ld de, #4
				add hl, de
				ld de, #8
				add ix, de
			dec c
			jp nz, ROW_LOOP_LEFT








		pop ix
		ret
	__endasm;

}



void real_main(){
	clearScreen();
	setCpuSpeed(3);
	
	



	set();
	random_spawn();
	// *(char*)gameData = 3;
	renderBoard();



	INIT_GREYSCALE();
	__asm
		ld	a, #0x46
		out	(0x36), a	;128 Hz
		ld	a, #0
		out	(0x37), 	a
		ld	a, #13
		out	(0x38), a
	__endasm;
	
	*(char*)WAIT_LOC = *(char*)(0x85A6);
	*(char*)CONTRAST_LOC = *(char*)(0x85A6+1);
	
	setCpuSpeed(3);
	// greyPutSprite(10, 5, Untitled4_WIDTH, Untitled4_HEIGHT, Untitled4_DATA);

	*((char*)MAX_COL)=8;

	*((char*)START_ROW) = ROW_CONST+3;
	*((char*)END_ROW) = ROW_END_CONST-3;
	score_changed = 1;
	while (1){
		wait(1);
		
		

		// render scoreboard
		if (score_changed != 0){
			__asm di __endasm;
			swap(); 

			__asm ei __endasm;

			__asm
				ld a, #15
				ld (#penRow), a
				ld a, #67
				ld (#penCol), a
				push ix
			__endasm;
			fputs("Score:");
			__asm
			ld a, #15+8
			ld (#penRow), a
			ld a, #67
			ld (#penCol), a
			__endasm;
			number(1234);
			__asm
			ld a, #15+8+8
			ld (#penRow), a
			ld a, #67
			ld (#penCol), a
			__endasm;

			fputs("Time:");
			__asm
			ld a, #15+8+8+8
			ld (#penRow), a
			ld a, #67
			ld (#penCol), a
			
			__endasm;
			number(1234);


			__asm
				pop ix
			__endasm;
			score_changed = 1;
		}



		scanKeys();
		if (skClear == lastPressedKey())
			break;
		else if (skLeft == lastPressedKey()){
			rotLeft();
			random_spawn();
			__asm
			push ix
			__endasm;
			renderBoard();
			__asm
			pop ix
			__endasm;
		}
		else if (skMode == lastPressedKey()){
			clearScreen();
			calibration_loop();
			clearScreen();
			clearGreyScaleBuffer();


		}

	}

	archive(dataName);


}

void main() {
	clearScreen();
	resetPen();


	real_main();



	

}